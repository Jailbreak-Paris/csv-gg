(function(e){function t(t){for(var i,s,o=t[0],l=t[1],u=t[2],d=0,f=[];d<o.length;d++)s=o[d],a[s]&&f.push(a[s][0]),a[s]=0;for(i in l)Object.prototype.hasOwnProperty.call(l,i)&&(e[i]=l[i]);c&&c(t);while(f.length)f.shift()();return r.push.apply(r,u||[]),n()}function n(){for(var e,t=0;t<r.length;t++){for(var n=r[t],i=!0,o=1;o<n.length;o++){var l=n[o];0!==a[l]&&(i=!1)}i&&(r.splice(t--,1),e=s(s.s=n[0]))}return e}var i={},a={app:0},r=[];function s(t){if(i[t])return i[t].exports;var n=i[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=i,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/";var o=window["webpackJsonp"]=window["webpackJsonp"]||[],l=o.push.bind(o);o.push=t,o=o.slice();for(var u=0;u<o.length;u++)t(o[u]);var c=l;r.push([0,"chunk-vendors"]),n()})({0:function(e,t,n){e.exports=n("56d7")},"56d7":function(e,t,n){"use strict";n.r(t);n("cadf"),n("551c"),n("f751"),n("097d");var i,a,r=n("2b0e"),s=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{attrs:{id:"app"}},[n("b-container",[n("h1",[e._v("CSV generator")]),n("h4",{staticClass:"text-muted"},[e._v("Générez un fichier CSV valide suivant un schéma")]),n("router-view")],1)],1)},o=[],l=n("2877"),u={},c=Object(l["a"])(u,s,o,!1,null,null,null),d=c.exports,f=n("8c4f"),h=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("b-form-group",{staticClass:"my-4",attrs:{label:"Choisissez un schéma à utiliser :",description:e.schemas&&e.schemas[e.schemaName]?e.schemas[e.schemaName].description:""}},[n("b-form-select",{attrs:{options:e.options},model:{value:e.schemaName,callback:function(t){e.schemaName=t},expression:"schemaName"}},[n("template",{slot:"first"},[n("option",{attrs:{disabled:""},domProps:{value:null}},[e._v("Choisissez un schéma")])])],2)],1),e.schema?n("schema-form",{attrs:{"schema-meta":e.schema,"schema-name":e.schemaName}}):e._e()],1)},m=[],p=n("a4bb"),v=n.n(p),b=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[e.lines.length>0?n("div",{staticClass:"my-4"},[n("b-table",{attrs:{striped:"",hover:"",items:e.items,fields:e.fields},scopedSlots:e._u([{key:"actions",fn:function(t){return[n("b-button",{staticClass:"mr-1",attrs:{size:"sm",variant:"danger"},on:{click:function(n){return e.deleteLine(t.index)}}},[e._v("\n                  Supprimer\n              ")])]}}],null,!1,359536991)}),n("b-button",{staticClass:"mr-2",attrs:{href:e.csvLink,download:e.filename,type:"button",variant:"primary"}},[e._v("Télécharger le CSV")]),n("b-button",{attrs:{disabled:e.addingLine,type:"button",variant:"primary"},on:{click:function(t){return t.preventDefault(),e.addLine(t)}}},[e._v("Ajouter une ligne")])],1):e._e(),n("b-form",{directives:[{name:"show",rawName:"v-show",value:e.addingLine,expression:"addingLine"}],staticClass:"my-4",attrs:{novalidate:""},on:{submit:function(t){return t.preventDefault(),e.submit(t)}}},[n("div",{ref:"container"}),n("b-button",{attrs:{type:"submit",variant:"primary",disabled:!e.hasValues}},[e._v("Valider la ligne")])],1)],1)},g=[],y=n("db0c"),N=n.n(y),w=(n("7f7f"),n("6762"),n("2fdb"),n("75fc")),C=(n("ac6a"),function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{},[n("b-form-group",{attrs:{"label-cols-sm":"4","label-cols-lg":"3",description:e.field.description,label:e.field.name,"label-for":"field-"+e.field.name,"invalid-feedback":e.error.content,"valid-feedback":"Ce champ est valide",state:e.isValid}},[n("b-form-input",{attrs:{id:"field-"+e.field.name,placeholder:e.field.example,state:e.isValid,trim:""},on:{input:e.onInput},model:{value:e.value,callback:function(t){e.value=t},expression:"value"}})],1)],1)}),j=[],_=new r["a"],x={props:{field:Object},data:function(){return{error:!1,formValidated:!1,value:null}},mounted:function(){var e=this;_.$on("field-error",function(t,n){e.field.name===t&&(e.error=n)}),_.$on("field-no-error",function(t){e.field.name===t&&(e.error=!1)}),_.$on("form-validated",function(){e.formValidated=!0}),_.$on("form-reset",function(){e.formValidated=!1,e.error=!1,e.value=null})},computed:{isValid:function(){return this.formValidated?!this.error:null}},methods:{onInput:function(e){this.formValidated=!1,this.error=!1,_.$emit("field-value-changed",this.field.name,e)}}},$=x,V=Object(l["a"])($,i,a,!1,null,null,null),L=V.exports,F={name:"StringField",mixins:[L]},O=F,k=Object(l["a"])(O,C,j,!1,null,null,null),S=k.exports,E=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("b-form-group",{attrs:{"label-cols-sm":"4","label-cols-lg":"3",description:e.field.description,label:e.field.name,"label-for":"field-"+e.field.name,"invalid-feedback":e.error.content,"valid-feedback":"Ce champ est valide",state:e.isValid}},[n("b-form-select",{attrs:{id:"field-"+e.field.name,options:e.options,state:e.isValid},on:{input:e.onInput},model:{value:e.value,callback:function(t){e.value=t},expression:"value"}})],1)],1)},M=[],D={name:"SelectField",mixins:[L],computed:{options:function(){return this.field.constraints.enum}}},P=D,H=Object(l["a"])(P,E,M,!1,null,null,null),T=H.exports,z="https://api.validata.etalab.studio",I={name:"schemaForm",components:{},props:{schemaMeta:Object,schemaName:String},data:function(){return{schema:{},errors:{},values:{},fieldNames:[],faultyFields:[],lines:[],formValidated:!1,addingLine:!0,hasValues:!1,fieldNodes:[]}},watch:{schemaMeta:function(){this.removeFieldNodes(),this.lines=[],this.addingLine=!0,this.fieldNames=[],this.formValidated=!1,this.hasValues=!1,this.values={},this.errors={},this.faultyFields=[],this.buildForm(this.schemaMeta)}},mounted:function(){var e=this;this.buildForm(this.schemaMeta),_.$on("field-value-changed",function(t,n){e.values[t]=n,e.computeHasValues()})},computed:{filename:function(){var e=new Date,t=[this.schemaName,e.toISOString()].join("_");return"".concat(t,".csv")},fields:function(){return[].concat(Object(w["a"])(this.fieldNames.map(function(e){return{key:e,label:e}})),[{key:"actions",label:""}])},csvLink:function(){var e=this.buildFullCsvContent(),t=new Blob(["\ufeff"+e],{type:"text/csv"});return window.URL.createObjectURL(t)},items:function(){var e=this;return this.lines.map(function(t){var n={};return e.fieldNames.forEach(function(e,i){n[e]=t[i]}),n})}},methods:{containsKey:function(e,t){return v()(e).includes(t)},buildForm:function(){var e=this,t=this.$loading.show();fetch(this.schemaMeta.schema).then(function(e){return e.json()}).then(function(t){e.schema=t,e.schema.fields.forEach(function(t){e.fieldNames.push(t.name),e.fieldNodes.push(e.addField(t))})}).finally(function(){t.hide()})},computeHasValues:function(){this.hasValues=v()(this.values).length>0&&N()(this.values).some(function(e){return""!==e})},buildHeaderLine:function(){return this.fieldNames.map(function(e){return'"'.concat(e,'"')}).join(",")},getCurrentLine:function(){var e=this;return this.fieldNames.map(function(t){return e.values[t]||""})},buildLine:function(e){return e.map(function(e){return'"'.concat(e,'"')}).join(",")},buildCurrentCsvContent:function(){return[this.buildHeaderLine(),this.buildLine(this.getCurrentLine())].join("\r\n")},buildFullCsvContent:function(){var e=this,t=this.lines.map(function(t){return e.buildLine(t)});return[this.buildHeaderLine()].concat(Object(w["a"])(t)).join("\r\n")},buildFormData:function(){var e=new FormData,t=new Blob(["\ufeff"+this.buildCurrentCsvContent()],{type:"text/csv"});return e.append("file",t,"data.csv"),e.append("schema",this.schemaName),e},removeFieldNodes:function(){var e=this;this.fieldNodes.forEach(function(t){e.$refs.container.removeChild(t)}),this.fieldNodes=[]},addField:function(e){var t=this.containsKey(e,"constraints")&&this.containsKey(e.constraints,"enum");if(t){var n=r["a"].extend(T),i=new n({propsData:{field:e}});return i.$mount(),this.$refs.container.appendChild(i.$el)}var a=r["a"].extend(S),s=new a({propsData:{field:e}});return s.$mount(),this.$refs.container.appendChild(s.$el)},dispatchError:function(e){var t=e["column-number"];this.faultyFields.push(this.fieldNames[t-1]),_.$emit("field-error",this.fieldNames[t-1],e)},dispatchNoError:function(){var e=this;this.fieldNames.forEach(function(t){-1===e.faultyFields.indexOf(t)&&_.$emit("field-no-error",t)})},dispatchFormValidated:function(){_.$emit("form-validated")},dispatchReset:function(){_.$emit("form-reset")},submit:function(){var e=this,t=this.$loading.show();fetch("".concat(z,"/validate"),{method:"POST",body:this.buildFormData()}).then(function(e){return e.json()}).then(function(t){e.formValidated=!0,e.faultyFields=[];var n=t.report.tables[0].errors;n&&n.length>0?n.forEach(function(t){e.dispatchError(t)}):(e.addingLine=!1,e.lines.push(e.getCurrentLine())),e.dispatchNoError(),e.dispatchFormValidated()}).finally(function(){t.hide()})},addLine:function(){this.addingLine=!0,this.formValidated=!1,this.dispatchReset()},deleteLine:function(e){this.lines.splice(e,1),0===this.lines.length&&this.addLine()}}},R=I,K=Object(l["a"])(R,b,g,!1,null,null,null),B=K.exports,J="https://api.validata.etalab.studio",U={name:"home",components:{SchemaForm:B},data:function(){return{schemaName:null,schemas:null,options:[]}},mounted:function(){var e=this;this.schemaName=this.$route.params.schema;var t=this.$loading.show();fetch("".concat(J,"/schemas")).then(function(e){return e.json()}).then(function(t){e.schemas=t.schemas,e.options=v()(e.schemas).map(function(t){return{value:t,text:e.schemas[t].title}})}).finally(function(){t.hide()})},computed:{schema:function(){if(this.schemaName&&this.schemas)return this.schemas[this.schemaName]}}},A=U,G=Object(l["a"])(A,h,m,!1,null,null,null),q=G.exports;r["a"].use(f["a"]);var Q=new f["a"]({mode:"history",base:"/",routes:[{path:"/:schema",name:"home_schema",component:q},{path:"/",name:"home",component:q}]}),W=n("9f7b"),X=n.n(W),Y=n("9062"),Z=n.n(Y);n("e40d"),n("f9e3"),n("2dd8");r["a"].config.productionTip=!1,r["a"].use(X.a),r["a"].use(Z.a),new r["a"]({router:Q,render:function(e){return e(d)}}).$mount("#app")}});
//# sourceMappingURL=app.1bb30d67.js.map